# 飞书任务自动日报/周报机器人

一个基于飞书API的智能任务管理机器人，能够自动读取团队成员的任务、评论，结合AI大模型生成结构化的日报和周报，并推送到指定飞书群聊。

## 功能特性

- 🤖 **全自动化**：无需人工干预，自动获取所有已授权用户的任务
- 👥 **多成员支持**：支持多个团队成员的任务统计和汇总
- 📝 **智能总结**：基于豆包大模型AI，智能分析任务进展和评论
- 📅 **定时推送**：支持定时自动推送日报/周报到指定群聊
- 🔄 **Token自动刷新**：自动刷新用户访问令牌，确保长期稳定运行
- 💬 **评论分析**：自动获取任务评论，提供更全面的工作进展信息

## 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   飞书OAuth2    │    │   任务数据获取   │    │   AI智能总结     │
│   用户授权      │───▶│   评论数据获取   │───▶│   豆包大模型     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Token管理     │    │   数据分组处理   │    │   群聊推送      │
│   自动刷新      │    │   按用户日期     │    │   定时任务      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 安装配置

### 1. 环境要求

- Python 3.7+
- 飞书开发者账号
- 豆包大模型API密钥

### 2. 安装依赖

```bash
# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
# Windows
.venv\Scripts\activate
# Linux/Mac
source .venv/bin/activate

# 安装依赖包
pip install requests apscheduler fastapi uvicorn
```

### 3. 飞书应用配置

1. 登录[飞书开放平台](https://open.feishu.cn/)
2. 创建应用，获取 `app_id` 和 `app_secret`
3. 配置应用权限：
   - `task:read` - 读取任务权限
   - `contact:read` - 读取用户信息权限
   - `message:send` - 发送消息权限
4. 发布应用

### 4. 配置文件

创建 `config.py` 文件：

```python
class config:
    # 飞书应用配置
    FEISHU_APP_ID = "your_app_id"
    FEISHU_APP_SECRET = "your_app_secret"
    
    # 任务清单ID
    TASKLIST_GUID = "your_tasklist_guid"
    
    # 目标群聊ID
    TARGET_CHAT_ID = "your_chat_id"
    
    # 豆包大模型配置
    DOUBAO_API_KEY = "your_doubao_api_key"
    DOUBAO_BASE_URL = "https://api.doubao.com/v1/chat/completions"
    DOUBAO_MODEL = "doubao-pro"
```

## 使用方法

### 1. 用户授权

启动授权服务：

```bash
python auth_server.py
```

访问 `http://localhost:8000/auth` 进行用户授权，系统会自动保存用户的访问令牌。

### 2. 手动测试

```bash
python main.py
```

系统会自动：
- 读取所有已授权用户
- 获取任务清单中的所有任务
- 获取任务评论
- 生成AI总结
- 推送到指定群聊

### 3. 定时推送

```bash
python push_scheduler.py
```

系统会在每天9:00自动执行推送任务，包括：
- 自动刷新所有用户的访问令牌
- 获取最新任务数据
- 生成日报/周报
- 推送到群聊

## 文件结构

```
FeishuBot/
├── README.md              # 项目说明文档
├── config.py              # 配置文件
├── main.py                # 主程序
├── auth_server.py         # 用户授权服务
├── token_store.py         # Token管理
├── push_scheduler.py      # 定时推送服务
├── token.json             # 用户Token存储（自动生成）
└── requirements.txt       # 依赖包列表
```

## 核心功能详解

### 任务数据获取

- 使用飞书任务API获取指定任务清单下的所有任务
- 支持分页获取，确保获取完整数据
- 自动处理任务分配者、关注者等角色信息

### 评论数据获取

- 优先使用任务分配者的访问令牌获取评论
- 避免权限问题导致的评论获取失败
- 支持多用户评论的完整获取

### AI智能总结

- 基于豆包大模型进行任务内容分析
- 生成结构化的日报和周报格式
- 包含任务进展、计划、描述摘要等信息

### Token自动管理

- 自动刷新过期的访问令牌
- 支持多用户Token的批量管理
- 确保定时任务的稳定运行

## 输出示例

### 原始数据输出
```
【张三】
所有任务：
- 完成用户界面设计（✅已完成，日期:2024-01-15）
  描述：设计新的用户登录界面
  评论：设计稿已通过评审 | 需要调整按钮样式

- 数据库优化（❌未完成，日期:2024-01-20）
  描述：优化查询性能
  评论：正在分析慢查询日志
```

### AI总结输出
```
📊 团队日报 - 2024年1月15日

👤 张三
✅ 已完成：
• 用户界面设计：设计稿已通过评审，需要调整按钮样式

🔄 进行中：
• 数据库优化：正在分析慢查询日志，预计1月20日完成

📋 今日计划：
• 继续数据库优化工作
• 调整UI设计中的按钮样式
```

## 故障排除

### 常见问题

1. **Token过期**
   - 系统会自动刷新Token
   - 如果刷新失败，需要重新授权用户

2. **任务获取失败**
   - 检查任务清单ID是否正确
   - 确认用户是否有任务读取权限

3. **评论获取失败**
   - 检查任务分配者的Token是否有效
   - 确认用户是否有评论读取权限

4. **推送失败**
   - 检查群聊ID是否正确
   - 确认机器人是否已加入群聊

### 调试模式

在 `main.py` 中可以看到详细的调试输出，包括：
- API请求和响应
- 任务和评论获取过程
- 数据处理和分组结果

## 扩展功能

### 自定义推送时间

修改 `push_scheduler.py` 中的定时配置：

```python
# 每天18:30推送
scheduler.add_job(job, 'cron', hour=18, minute=30)

# 每周一9:00推送周报
scheduler.add_job(job, 'cron', day_of_week='mon', hour=9, minute=0)
```

### 自定义AI总结格式

修改 `main.py` 中的AI提示词，定制总结格式和内容。

### 多任务清单支持

扩展代码支持多个任务清单的并行处理。

## 贡献指南

欢迎提交Issue和Pull Request来改进项目！


## wanwindy@163.com

如有问题或建议，请通过Issue联系。 
